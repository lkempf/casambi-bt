# ESPHome Bluetooth Proxy Configuration for Casambi
# This configuration turns an ESP32 into a Bluetooth proxy for Home Assistant
# allowing remote Bluetooth devices to communicate through the ESP32

substitutions:
  name: casambi-bt-proxy
  friendly_name: Casambi Bluetooth Proxy

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: true
  project:
    name: casambi.bluetooth-proxy
    version: "1.0"

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    # ESP-IDF framework provides better Bluetooth performance
    sdkconfig_options:
      CONFIG_BT_BLE_50_FEATURES_SUPPORTED: y
      CONFIG_BT_BLE_42_FEATURES_SUPPORTED: y
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "10"

# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  # Optional: Set a password for API access
  # password: "your_api_password"
  
  # Optional: Use encryption for API communication
  # encryption:
  #   key: "base64_encoded_encryption_key"

# Enable Over-The-Air updates
ota:
  platform: esphome

# WiFi Configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Optional: Use static IP for better reliability
  # manual_ip:
  #   static_ip: 192.168.1.100
  #   gateway: 192.168.1.1
  #   subnet: 255.255.255.0
  #   dns1: 192.168.1.1

  # Enable fallback hotspot in case WiFi connection fails
  ap:
    ssid: "${friendly_name} Hotspot"
    password: !secret ap_password

# Captive portal for easy WiFi configuration
captive_portal:

# Web server for monitoring (optional)
web_server:
  port: 80

# Bluetooth Proxy Configuration
esp32_ble_tracker:
  scan_parameters:
    # Interval between scan windows
    interval: 1100ms
    # Duration of scan window - set equal to interval for continuous scanning
    window: 1100ms
    # Active scanning requests more data from devices
    active: true
    # Continuous scanning uses more power but ensures better coverage
    continuous: true

bluetooth_proxy:
  # Enable active connections (required for Casambi control)
  active: true
  # Number of simultaneous BLE connections (max 3 recommended)
  connection_slots: 3

# Button for safe mode (optional but recommended)
button:
  - platform: restart
    name: "${friendly_name} Restart"
  - platform: safe_mode
    name: "${friendly_name} Safe Mode"

# Sensor to monitor WiFi signal strength (optional)
sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

# Switch to enable/disable Bluetooth proxy (optional)
switch:
  - platform: ble_scanner
    name: "${friendly_name} BLE Scanner"

# Status LED (optional - configure based on your board)
# light:
#   - platform: status_led
#     name: "${friendly_name} Status LED"
#     pin: GPIO2